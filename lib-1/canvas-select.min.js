!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("fabric/fabric-impl")):"function"==typeof define&&define.amd?define(["fabric/fabric-impl"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).CanvasSelect=e(t.fabric)}(this,(function(t){"use strict";function e(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var i=e(t),n=function(t,e){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},n(t,e)};
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */function a(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function i(){this.constructor=t}n(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}var s=function(){return s=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var a in e=arguments[i])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t},s.apply(this,arguments)};function o(t,e){var i="function"==typeof Symbol&&t[Symbol.iterator];if(!i)return t;var n,a,s=i.call(t),o=[];try{for(;(void 0===e||e-- >0)&&!(n=s.next()).done;)o.push(n.value)}catch(t){a={error:t}}finally{try{n&&!n.done&&(i=s.return)&&i.call(s)}finally{if(a)throw a.error}}return o}var h=function(t,e){this.label="",this.hideLabel=!1,this.coor=[],this.rectangleConnectivity=[],this.lineCoorIndex=[],this.active=!1,this.creating=!1,this.dragging=!1,this.uuid=function(){for(var t=[],e="0123456789abcdef",i=0;i<36;i++){var n=Math.floor(16*Math.random());t[i]=e.slice(n,n+1)}t[14]="4";var a=3&t[19]|8;return t[19]=e.slice(a,a+1),t[8]=t[13]=t[18]=t[23]="-",t.join("")}(),this.data={},this.previousCoor=[],t.index=e,this.index=e,Object.assign(this,t)},r=function(t){function e(e,i){var n=t.call(this,e,i)||this;return n.type=1,n}return a(e,t),Object.defineProperty(e.prototype,"ctrlsData",{get:function(){var t=o(this.coor,2),e=o(t[0],2),i=e[0],n=e[1],a=o(t[1],2),s=a[0],h=a[1];return[[i,n],[i+(s-i)/2,n],[s,n],[s,n+(h-n)/2],[s,h],[i+(s-i)/2,h],[i,h],[i,n+(h-n)/2]]},enumerable:!1,configurable:!0}),e}(h),c=function(t){function e(e,i){var n=t.call(this,e,i)||this;return n.type=2,n}return a(e,t),Object.defineProperty(e.prototype,"ctrlsData",{get:function(){return this.coor.length>2?this.coor:[]},enumerable:!1,configurable:!0}),e}(h),l=function(t){function e(e,i){var n=t.call(this,e,i)||this;return n.type=3,n}return a(e,t),e}(h),u=function(){function t(){this._eventTree={}}return t.prototype.on=function(t,e){var i=this._eventTree[t];Array.isArray(i)?i.push(e):this._eventTree[t]=[e]},t.prototype.emit=function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];var n=this._eventTree[t];Array.isArray(n)&&n.forEach((function(t){return t.apply(void 0,function(t,e){for(var i=0,n=e.length,a=t.length;i<n;i++,a++)t[a]=e[i];return t}([],o(e)))}))},t.prototype.off=function(t,e){var i=this._eventTree[t],n=i.find((function(t){return t===e}));Array.isArray(i)&&n&&i.splice(n,1)},t}(),d=function(t){function e(e,i){var n=t.call(this,e,i)||this;return n.type=4,n}return a(e,t),Object.defineProperty(e.prototype,"ctrlsData",{get:function(){return this.coor.length>1?this.coor:[]},enumerable:!1,configurable:!0}),e}(h),v=function(t){function e(e,i){var n=t.call(this,e,i)||this;return n.type=5,n.radius=0,n.radius=e.radius||n.radius,n}return a(e,t),Object.defineProperty(e.prototype,"ctrlsData",{get:function(){var t=o(this.coor,2),e=t[0],i=t[1];return[[e,i-this.radius],[e+this.radius,i],[e,i+this.radius],[e-this.radius,i]]},enumerable:!1,configurable:!0}),e}(h),p="1.0.31",f=function(t){function e(e,i){var n=t.call(this,e,i)||this;return n.type=6,n}return a(e,t),Object.defineProperty(e.prototype,"ctrlsData",{get:function(){return this.coor.length>1?this.coor:[]},enumerable:!1,configurable:!0}),e}(h);return function(t){function e(e,n){var a=t.call(this)||this;a.version=p,a.lock=!1,a.MIN_WIDTH=10,a.MIN_HEIGHT=10,a.MIN_RADIUS=5,a.strokeStyle="#0f0",a.fillStyle="rgba(0, 0, 255,0.1)",a.activeStrokeStyle="#f00",a.activeFillStyle="rgba(255, 0, 0,0.1)",a.ctrlStrokeStyle="#000",a.ctrlFillStyle="#fff",a.ctrlRadius=3,a.hideLabel=!1,a.labelFillStyle="#fff",a.labelFont="10px sans-serif",a.textFillStyle="#000",a.labelMaxLen=10,a.WIDTH=0,a.HEIGHT=0,a.dataset=[],a.remmberOrigin=[0,0],a.createType=0,a.ctrlIndex=-1,a.cursor="auto",a.image=new Image,a.IMAGE_WIDTH=0,a.IMAGE_ORIGIN_HEIGHT=0,a.IMAGE_HEIGHT=0,a.originX=0,a.originY=0,a.scaleStep=0,a.scrollZoom=!0,a.dblTouch=300,a.dblTouchStore=0,a.alpha=!0,a.focusMode=!1,a.scaleTouchStore=0,a.isTouch2=!1,a.isDragging=!1,a.dragStartX=0,a.dragStartY=0,a.allowPanning=!1,a.RemoveSelectionOnKey="Backspace",a.rectangleConnectivity=[],a.parentRectangleConnectivity=null,a.childRectangleConnectivity=null,a.keyRectangleConnectivity=null,a.valueRectangleConnectivity=null,a.hideAnnotateLabels=!1,a.LineWidth=1.5,a.ZoomLevel=100,a.ScrollTop=0,a.scrollStartX=0,a.scrollStartY=0,a.rightClickMoveEvent=!0,a.handleLoad=a.handleLoad.bind(a),a.handleContextmenu=a.handleContextmenu.bind(a),a.handleMousewheel=a.handleMousewheel.bind(a),a.handleScroll=a.handleScroll.bind(a),a.handleMouseDown=a.handleMouseDown.bind(a),a.handelMouseMove=a.handelMouseMove.bind(a),a.handelMouseUp=a.handelMouseUp.bind(a),a.handelLeave=a.handelLeave.bind(a),a.handelDblclick=a.handelDblclick.bind(a),a.handelKeyup=a.handelKeyup.bind(a);var s="string"==typeof e?document.querySelector(e):e;return s instanceof HTMLCanvasElement?(a.canvas=new i.default.Canvas(s),a.canvasParentNode=a.canvas.getElement().parentNode,a.offScreen=new i.default.Canvas(document.createElement("canvas")),a.initSetting(),a.initEvents(),n&&a.setImage(n)):console.warn("HTMLCanvasElement is required!"),a}return a(e,t),Object.defineProperty(e.prototype,"setDragging",{set:function(t){this.allowPanning=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"setRightClickMoveEvent",{set:function(t){this.rightClickMoveEvent=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"activeShape",{get:function(){return this.dataset.find((function(t){return t.active}))||{}},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"scale",{get:function(){return this.IMAGE_ORIGIN_WIDTH&&this.IMAGE_WIDTH?this.IMAGE_WIDTH/this.IMAGE_ORIGIN_WIDTH:1},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"imageMin",{get:function(){return Math.min(this.IMAGE_WIDTH,this.IMAGE_HEIGHT)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"imageOriginMax",{get:function(){return Math.max(this.IMAGE_ORIGIN_WIDTH,this.IMAGE_ORIGIN_HEIGHT)},enumerable:!1,configurable:!0}),e.prototype.mergeEvent=function(t){var e=0,i=0,n=0,a=0,o=!1;if(window.TouchEvent&&t instanceof TouchEvent){var h=t.touches[0],r=h.clientX,c=h.clientY,l=t.target.getBoundingClientRect(),u=l.left,d=l.top;if(e=Math.round(r-u),i=Math.round(c-d),2===t.touches.length){var v=t.touches[1]||{},p=v.clientX,f=void 0===p?0:p,g=v.clientY,y=void 0===g?0:g;n=Math.round(Math.abs((f-r)/2+r)-u),a=Math.round(Math.abs((y-c)/2+c)-d)}o=!0}else e=t.offsetX,i=t.offsetY;return s(s({},t),{mouseX:e,mouseY:i,mouseCX:n,mouseCY:a,isMobile:o})},e.prototype.handleLoad=function(){this.emit("load",this.image.src),this.IMAGE_ORIGIN_WIDTH=this.IMAGE_WIDTH=this.image.width,this.IMAGE_ORIGIN_HEIGHT=this.IMAGE_HEIGHT=this.image.height,this.fitZoom()},e.prototype.handelLeave=function(t){t.preventDefault(),this.isDragging=!1},e.prototype.handleScroll=function(t){this.originX=-1*t.target.scrollLeft,this.originY=-1*t.target.scrollTop},e.prototype.handleContextmenu=function(t){t.preventDefault(),this.evt=t,this.lock},e.prototype.handleMousewheel=function(t){if(!this.lock&&this.scrollZoom&&t.ctrlKey){t.preventDefault(),t.stopPropagation();var e=this.mergeEvent(t),i=e.mouseX,n=e.mouseY;this.mouse=[i,n],this.setScale(t.deltaY<0)}},e.prototype.handleMouseDown=function(t){var e=this;t.stopPropagation();var i=window.TouchEvent&&t instanceof TouchEvent;if((this.allowPanning||(!i&&2===t.buttons&&3===t.which||i&&1===t.touches.length&&!this.isTouch2)&&this.rightClickMoveEvent)&&(this.isDragging=!0,this.dragStartX=t.clientX,this.dragStartY=t.clientY,this.scrollStartX=this.canvasParentNode.scrollLeft,this.scrollStartY=this.canvasParentNode.scrollTop),this.evt=t,!this.lock){var n=this.mergeEvent(t),a=n.mouseX,s=n.mouseY,h=n.mouseCX,u=n.mouseCY,p=Math.round(a/this.scale)+this.originX/this.scale,g=Math.round(s/this.scale)+this.originY/this.scale;if(this.mouse=i&&2===t.touches.length?[h,u]:[a,s],this.remmberOrigin=[a-this.originX,s-this.originY],!i&&1===t.buttons||i&&1===t.touches.length||(!i&&2===t.buttons||i&&2===t.touches.length)&&!this.rightClickMoveEvent){var y=this.activeShape.ctrlsData||[];if(this.ctrlIndex=y.findIndex((function(t){return e.isPointInCircle(e.mouse,t,e.ctrlRadius)})),this.ctrlIndex>-1){var I=o(y[this.ctrlIndex],2),S=I[0],m=I[1];this.remmber=[[p-S,g-m]]}else if(this.isInBackground(t)){if(this.activeShape.creating){if([2,4,6].includes(this.activeShape.type)){var M=o(this.activeShape.coor[this.activeShape.coor.length-1],2),b=M[0],E=M[1];if(b!==p&&E!==g){var H=Math.round(p-this.originX/this.scale),T=Math.round(g-this.originY/this.scale);this.activeShape.coor.push([H,T]),this.childRectangleConnectivity=null,6===this.activeShape.type&&this.createConnectivity()}}}else if(this.createType>0){var C=void 0,w=[H=Math.round(p-this.originX/this.scale),T=Math.round(g-this.originY/this.scale)];switch(this.createType){case 1:(C=new r({coor:[w,w]},this.dataset.length)).creating=!0;break;case 2:(C=new c({coor:[w]},this.dataset.length)).creating=!0;break;case 3:C=new l({coor:w},this.dataset.length),this.emit("add",C);break;case 4:(C=new d({coor:[w]},this.dataset.length)).creating=!0;break;case 5:(C=new v({coor:w},this.dataset.length)).creating=!0;break;case 6:(C=new f({coor:[w]},this.dataset.length)).creating=!0,this.parentRectangleConnectivity=this.findReactengle();break;case 7:(C=new r({coor:[w,w]},this.dataset.length)).type=this.createType,C.creating=!0,this.parentRectangleConnectivity=C;break;case 8:(C=new r({coor:[w,w]},this.dataset.length)).type=this.createType,C.creating=!0}this.dataset.forEach((function(t){t.active=!1})),C.active=!0,this.dataset.push(C)}else{var G=o(this.hitOnShape(this.mouse),2),x=G[0],_=G[1];if(x>-1){if(this.dataset.forEach((function(t,e){return t.active=e===x})),_.dragging=!0,this.dataset.splice(x,1),this.dataset.push(_),this.remmber=[],[3,5].includes(_.type)){var D=o(_.coor,2);b=D[0],E=D[1];this.remmber=[[p-b,g-E]]}else _.coor.forEach((function(t){e.remmber.push([p-t[0],g-t[1]])}));this.emit("select",_)}else this.activeShape.active=!1,this.dataset.sort((function(t,e){return t.index-e.index}))}this.isDragging||this.update()}}}},e.prototype.handelMouseMove=function(t){t.stopPropagation();var e=window.TouchEvent&&t instanceof TouchEvent;if(this.isDragging&&this.allowPanning||(!e&&2===t.buttons&&3===t.which||e&&1===t.touches.length&&!this.isTouch2)&&this.rightClickMoveEvent){var i=t.clientX-this.dragStartX,n=t.clientY-this.dragStartY;this.originX=this.scrollStartX-i,this.originY=this.scrollStartY-n,this.canvasParentNode.scrollLeft=this.originX,this.canvasParentNode.scrollTop=this.originY}else{if(this.evt=t,this.lock)return;var a=this.mergeEvent(t),s=a.mouseX,h=a.mouseY,r=a.mouseCX,c=a.mouseCY,l=Math.round(s/this.scale)+this.originX/this.scale,u=Math.round(h/this.scale)+this.originY/this.scale;if(this.mouse=e&&2===t.touches.length?[r,c]:[s,h],!e&&1===t.buttons||e&&1===t.touches.length||(!e&&2===t.buttons||e&&2===t.touches.length)&&!this.rightClickMoveEvent&&this.activeShape.type){if(this.ctrlIndex>-1&&(this.isInBackground(t)||5===this.activeShape.type)){var d=o(this.remmber,1),v=o(d[0],2),p=v[0],f=v[1];if([1,7,8].includes(this.activeShape.type)){var g=o(this.activeShape.coor,2),y=o(g[0],2),I=y[0],S=y[1],m=o(g[1],2),M=m[0],b=m[1],E=[];switch(this.ctrlIndex){case 0:E=[[l-p,u-f],[M,b]];break;case 1:case 7:case 8:E=[[I,u-f],[M,b]];break;case 2:E=[[I,u-f],[l-p,b]];break;case 3:E=[[I,S],[l-p,b]];break;case 4:E=[[I,S],[l-p,u-f]];break;case 5:E=[[I,S],[M,u-f]];break;case 6:E=[[l-p,S],[M,u-f]]}var H=o(E,2),T=o(H[0],2),C=T[0],w=T[1],G=o(H[1],2),x=G[0],_=G[1];x-C>=this.MIN_WIDTH&&_-w>=this.MIN_HEIGHT?this.activeShape.coor=E:this.emit("warn","Width cannot be less than ".concat(this.MIN_WIDTH,",Height cannot be less than").concat(this.MIN_HEIGHT,"ã€‚"))}else if([2,4,6].includes(this.activeShape.type)){var D=[Math.round(l-this.originX/this.scale),Math.round(u-this.originY/this.scale)];this.activeShape.coor.splice(this.ctrlIndex,1,D)}else if(5===this.activeShape.type){var k=Math.round(l-this.originX/this.scale)-this.activeShape.coor[0];k>=this.MIN_RADIUS&&(this.activeShape.radius=k)}}else if(this.activeShape.dragging){E=[];var R=!0,A=this.IMAGE_ORIGIN_WIDTH||this.WIDTH,L=this.IMAGE_ORIGIN_HEIGHT||this.HEIGHT;if([3,5].includes(this.activeShape.type)){var W=o(this.remmber[0],2),P=W[0];f=u-W[1];((p=l-P)<0||p>A||f<0||f>L)&&(R=!1),E=[p,f]}else for(var N=0;N<this.activeShape.coor.length;N++){var O=this.remmber[N];p=l-O[0],f=u-O[1];(p<0||p>A||f<0||f>L)&&(R=!1),E.push([p,f])}R&&(this.activeShape.coor=E)}else if(this.activeShape.creating&&this.isInBackground(t)){p=Math.round(l-this.originX/this.scale),f=Math.round(u-this.originY/this.scale);if(1===this.activeShape.type)this.activeShape.coor.splice(1,1,[p,f]);else if(5===this.activeShape.type){var X=o(this.activeShape.coor,2),Y=(I=X[0],S=X[1],Math.sqrt(Math.pow(I-p,2)+Math.pow(S-f,2)));this.activeShape.radius=Y}else 7!==this.activeShape.type&&8!==this.activeShape.type||this.activeShape.coor.splice(1,1,[p,f])}this.update()}else if([2,4,6].includes(this.activeShape.type)&&this.activeShape.creating)this.update();else if(!e&&2===t.buttons&&3===t.which||e&&1===t.touches.length&&!this.isTouch2);else if(e&&2===t.touches.length){this.isTouch2=!0;var j=t.touches[0],F=t.touches[1],U=this.scaleTouchStore;this.scaleTouchStore=Math.abs((F.clientX-j.clientX)*(F.clientY-j.clientY)),this.setScale(this.scaleTouchStore>U,!0)}}},e.prototype.handelMouseUp=function(t){var e;if(t.stopPropagation(),this.allowPanning&&(this.isDragging=!1),this.evt=t,!this.lock){if(window.TouchEvent&&t instanceof TouchEvent){if(0===t.touches.length&&(this.isTouch2=!1),Date.now()-this.dblTouchStore<this.dblTouch)return void this.handelDblclick(t);this.dblTouchStore=Date.now()}if(this.remmber=[],this.activeShape.type){if(this.activeShape.dragging=!1,this.activeShape.creating){if(1===this.activeShape.type){var i=o(this.activeShape.coor,2),n=o(i[0],2),a=n[0],h=n[1],r=o(i[1],2),c=r[0],l=r[1];Math.abs(a-c)<this.MIN_WIDTH||Math.abs(h-l)<this.MIN_HEIGHT?(this.dataset.pop(),this.emit("warn","Width cannot be less than ".concat(this.MIN_WIDTH,",Height cannot be less than ").concat(this.MIN_HEIGHT))):(this.activeShape.coor=[[Math.min(a,c),Math.min(h,l)],[Math.max(a,c),Math.max(h,l)]],this.activeShape.creating=!1,this.emit("add",this.activeShape))}else if(5===this.activeShape.type)this.activeShape.radius<this.MIN_RADIUS?(this.dataset.pop(),this.emit("warn","Radius cannot be less than ".concat(this.MIN_WIDTH))):(this.activeShape.creating=!1,this.emit("add",this.activeShape));else if(7===this.activeShape.type||8===this.activeShape.type){var u=o(this.activeShape.coor,2),d=o(u[0],2),v=(a=d[0],h=d[1],o(u[1],2));c=v[0],l=v[1];Math.abs(a-c)<this.MIN_WIDTH||Math.abs(h-l)<this.MIN_HEIGHT?(this.dataset.pop(),this.emit("warn","Width cannot be less than ".concat(this.MIN_WIDTH,",Height cannot be less than ").concat(this.MIN_HEIGHT))):(this.activeShape.coor=[[Math.min(a,c),Math.min(h,l)],[Math.max(a,c),Math.max(h,l)]],this.activeShape.creating=!1,this.emit("add",this.activeShape)),7===this.activeShape.type&&(this.childRectangleConnectivity=s({},this.valueRectangleConnectivity),this.valueRectangleConnectivity&&8===this.valueRectangleConnectivity.type&&this.keyValueConnectivity(t)),8===this.activeShape.type&&(this.parentRectangleConnectivity=s({},this.keyRectangleConnectivity),this.keyRectangleConnectivity&&7===this.keyRectangleConnectivity.type&&this.keyValueConnectivity(t))}this.update()}if([1,7,8].includes(this.activeShape.type)&&this.activeShape.active){if((null===(e=this.activeShape.previousCoor)||void 0===e?void 0:e.length)>0){var p=o(this.activeShape.coor,2),f=o(p[0],2),g=(a=f[0],h=f[1],o(p[1],2)),y=(c=g[0],l=g[1],o(this.activeShape.previousCoor,2)),I=o(y[0],2),S=I[0],m=I[1],M=o(y[1],2),b=M[0],E=M[1];if(Math.abs(c-a)===Math.abs(b-S)&&Math.abs(l-h)===Math.abs(E-m))return}this.activeShape.previousCoor=this.activeShape.coor,this.emit("updatedRect",this.activeShape)}}}},e.prototype.handelDblclick=function(t){t.stopPropagation(),this.evt=t,this.lock||[2,4].includes(this.activeShape.type)&&(2===this.activeShape.type&&this.activeShape.coor.length>2||4===this.activeShape.type&&this.activeShape.coor.length>1)&&(this.emit("add",this.activeShape),this.activeShape.creating=!1,this.update())},e.prototype.handelKeyup=function(t){t.stopPropagation(),this.evt=t,this.lock||document.activeElement!==document.body||this.activeShape.type&&([2,4,6].includes(this.activeShape.type)&&"Escape"===t.key?(this.activeShape.coor.length>1&&this.activeShape.creating?this.activeShape.coor.pop():this.deleteByIndex(this.activeShape.index),this.update()):t.key===this.RemoveSelectionOnKey&&this.deleteByIndex(this.activeShape.index))},e.prototype.keyValueConnectivity=function(t){if(this.valueRectangleConnectivity=null,this.keyRectangleConnectivity=null,!this.activeShape.creating){var e=this.mergeEvent(t),i=e.mouseX,n=e.mouseY;e.mouseCX,e.mouseCY;var a=Math.round(i/this.scale)+this.originX/this.scale,s=Math.round(n/this.scale)+this.originY/this.scale,o=Math.round(a-this.originX/this.scale),h=Math.round(s-this.originY/this.scale),r=new f({coor:[[o,h]]},this.dataset.length);r.creating=!0,this.dataset.forEach((function(t){t.active=!1})),r.active=!0,this.dataset.push(r),this.createConnectivity()}},e.prototype.findReactengle=function(){for(var t=this,e=this.dataset.length-1;e>-1;e--){var i=this.dataset[e],n=o(this.mouse,2),a=n[0],s=n[1];if(1===i.type){var h=o(i.coor.map((function(e){return e.map((function(e){return e*t.scale}))})),2),r=o(h[0],2),c=r[0],l=r[1],u=o(h[1],2),d=u[0],v=u[1];if(c+this.originX+this.canvasParentNode.scrollLeft-5<=a&&a<=d+this.originX+this.canvasParentNode.scrollLeft+5&&l+this.originY+this.canvasParentNode.scrollTop-5<=s&&s<=v+this.originY+this.canvasParentNode.scrollTop+5)return i}}},e.prototype.createConnectivity=function(){var t=this;if(6===this.activeShape.type){if(this.emit("add",this.activeShape),this.activeShape.creating=!1,6!==this.activeShape.type||this.childRectangleConnectivity||(this.childRectangleConnectivity=this.findReactengle()),this.parentRectangleConnectivity&&this.childRectangleConnectivity&&this.parentRectangleConnectivity.index!==this.childRectangleConnectivity.index){if(this.rectangleConnectivity.push([this.parentRectangleConnectivity.index,this.childRectangleConnectivity.index]),this.isArrayInArray(this.parentRectangleConnectivity.rectangleConnectivity,this.childRectangleConnectivity.rectangleConnectivity,this.rectangleConnectivity[0]))(e=this.dataset.findIndex((function(e){return e.index===t.activeShape.index})))>-1&&(this.emit("delete",this.dataset[e]),this.dataset.splice(e,1));else this.parentRectangleConnectivity.lineCoorIndex.push(this.activeShape.index),this.childRectangleConnectivity.lineCoorIndex.push(this.activeShape.index),this.activeShape.rectangleConnectivity.push([this.parentRectangleConnectivity.index,this.childRectangleConnectivity.index]),this.parentRectangleConnectivity.rectangleConnectivity.push([this.parentRectangleConnectivity.index,this.childRectangleConnectivity.index]),this.childRectangleConnectivity.rectangleConnectivity.push([this.parentRectangleConnectivity.index,this.childRectangleConnectivity.index]);this.rectangleConnectivity=[]}else{var e;(e=this.dataset.findIndex((function(e){return e.index===t.activeShape.index})))>-1&&(this.emit("delete",this.dataset[e]),this.dataset.splice(e,1))}this.update()}else this.update()},e.prototype.isArrayInArray=function(t,e,i){if(!t.length&&!e.length)return!1;var n=o(i,2),a=n[0],s=n[1],h=t.some((function(t){var e=o(t,2),i=e[0],n=e[1];return!(i!==a&&i!==s||n!==a&&n!==s)})),r=e.some((function(t){var e=o(t,2),i=e[0],n=e[1];return!(i!==a&&i!==s||n!==a&&n!==s)}));return h||r},e.prototype.getDomRect=function(t){var e=o(t[0],2),i=e[0],n=e[1],a=o(t[1],2);return{x:i,y:n,width:a[0]-i,height:a[1]-n}},e.prototype.drawShortestLine=function(t,e,i){var n=this.getClosestMidpoints(t,e);i.coor[0]=[n[0].x,n[0].y],i.coor[1]=[n[1].x,n[1].y],this.drawLine(i)},e.prototype.getClosestMidpoints=function(t,e){for(var i=this.getMidpoints(t),n=this.getMidpoints(e),a=1/0,s=[],o=0;o<i.length;o++)for(var h=0;h<n.length;h++){var r=this.getDistance(i[o],n[h]);r<a&&(a=r,s=[i[o],n[h]])}return s},e.prototype.getMidpoints=function(t){var e=t.x,i=t.y,n=t.width,a=t.height,s=e+n/2,o=i+a/2;return[{x:e,y:o},{x:e+n,y:o},{x:s,y:i},{x:s,y:i+a}]},e.prototype.getDistance=function(t,e){var i=e.x-t.x,n=e.y-t.y;return Math.sqrt(i*i+n*n)},e.prototype.initSetting=function(){var t=window.devicePixelRatio||1;this.canvas.getElement().style.userSelect="none",this.WIDTH=this.canvas.getElement().clientWidth,this.HEIGHT=this.canvas.getElement().clientHeight,this.canvas.width=this.WIDTH*t,this.canvas.height=this.HEIGHT*t,this.canvas.getElement().style.width=this.WIDTH+"px",this.canvas.getElement().style.height=this.HEIGHT+"px",this.offScreen.width=this.WIDTH,this.offScreen.height=this.HEIGHT},e.prototype.initEvents=function(){this.image.addEventListener("load",this.handleLoad),this.canvas.on("touchstart",this.handleMouseDown),this.canvas.on("touchmove",this.handelMouseMove),this.canvas.on("touchend",this.handelMouseUp),this.canvas.on("contextmenu",this.handleContextmenu),this.canvas.on("mousewheel",this.handleMousewheel),this.canvas.on("wheel",this.handleMousewheel),this.canvas.on("mousedown",this.handleMouseDown),this.canvas.on("mousemove",this.handelMouseMove),this.canvas.on("mouseup",this.handelMouseUp),this.canvas.on("mouseleave",this.handelLeave),this.canvas.on("dblclick",this.handelDblclick),document.body.addEventListener("keyup",this.handelKeyup),this.canvasParentNode.addEventListener("scroll",this.handleScroll)},e.prototype.setImage=function(t){this.image.src=t},e.prototype.setData=function(t){var e=this;setTimeout((function(){var i=[];t.forEach((function(t,e){if(Object.prototype.toString.call(t).indexOf("Object")>-1){var n=void 0;switch(t.type){case 1:n=new r(t,e);break;case 2:n=new c(t,e);break;case 3:n=new l(t,e);break;case 4:n=new d(t,e);break;case 5:n=new v(t,e);break;case 6:n=new f(t,e);break;case 7:case 8:(n=new r(t,e)).type=t.type;break;default:console.warn("Invalid shape",t)}[1,2,3,4,5,6,7,8].includes(t.type)&&i.push(n)}else console.warn("Shape must be an enumerable Object.",t)})),e.dataset=i,e.update()}))},e.prototype.hitOnShape=function(t){for(var e,i=-1,n=this.dataset.length-1;n>-1;n--){var a=this.dataset[n];if(3===a.type&&this.isPointInCircle(t,a.coor,this.ctrlRadius)||5===a.type&&this.isPointInCircle(t,a.coor,a.radius*this.scale)||1===a.type&&this.isPointInRect(t,a.coor)||2===a.type&&this.isPointInPolygon(t,a.coor)||(4===a.type||6===a.type)&&this.isPointInLine(t,a.coor)||7===a.type&&this.isPointInRect(t,a.coor)||8===a.type&&this.isPointInRect(t,a.coor)){i=n,e=a;break}}return[i,e]},e.prototype.isInBackground=function(t){var e=this.mergeEvent(t),i=e.mouseX,n=e.mouseY;return i>=this.originX+this.canvasParentNode.scrollLeft&&n>=this.originY+this.canvasParentNode.scrollTop&&i<=this.originX+this.IMAGE_ORIGIN_WIDTH*this.scale+this.canvasParentNode.scrollLeft&&n<=this.originY+this.IMAGE_ORIGIN_HEIGHT*this.scale+this.canvasParentNode.scrollTop},e.prototype.isPointInRect=function(t,e){var i=this,n=o(t,2),a=n[0],s=n[1],h=o(e.map((function(t){return t.map((function(t){return t*i.scale}))})),2),r=o(h[0],2),c=r[0],l=r[1],u=o(h[1],2),d=u[0],v=u[1];return c<=a&&a<=d&&l<=s&&s<=v},e.prototype.isPointInPolygon=function(t,e){return!1},e.prototype.isPointInCircle=function(t,e,i){var n=this,a=o(t,2),s=a[0],h=a[1],r=o(e.map((function(t){return t*n.scale})),2),c=r[0],l=r[1];return Math.sqrt(Math.pow(c+(this.originX+this.canvasParentNode.scrollLeft)-s,2)+Math.pow(l+(this.originY+this.canvasParentNode.scrollTop)-h,2))<=i},e.prototype.isPointInLine=function(t,e){if(2===e.length){var i=o(e[0],2),n=i[0],a=i[1],s=o(e[1],2),h=s[0],r=s[1];n*=this.scale,h*=this.scale,a*=this.scale,r*=this.scale;var c=o(t,2),l=c[0],u=c[1];return this.isPointOnLine(l,u,n,a,h,r)}},e.prototype.isPointOnLine=function(t,e,i,n,a,s){var o=5/Math.max(this.scale,1);return this.circleLineIntersect(i,n,a,s,t,e,o)},e.prototype.circleLineIntersect=function(t,e,i,n,a,s,o){var h=i-t,r=n-e,c=((a-t)*h+(s-e)*r)/(h*h+r*r);if(c<0||c>1)return!1;var l=t+c*h,u=e+c*r;return Math.pow(l-a,2)+Math.pow(u-s,2)<=o},e.prototype.drawRect=function(t){var e=this;if(2===t.coor.length){var n=t.strokeStyle,a=t.fillStyle,s=t.active,h=t.creating,r=t.coor,c=o(r.map((function(t){return t.map((function(t){return Math.round(t*e.scale)}))})),2),l=o(c[0],2),u=l[0],d=l[1],v=o(c[1],2),p=v[0]-u,f=v[1]-d,g=new i.default.Rect({left:u,top:d,width:p,height:f,fill:a||this.fillStyle,stroke:s||h?this.activeStrokeStyle:n||this.strokeStyle,strokeWidth:this.LineWidth});this.canvas.add(g),this.canvas.renderAll(),this.hideAnnotateLabels||this.drawLabel(r[0],t)}},e.prototype.drawPolygon=function(t){t.strokeStyle,t.fillStyle,t.active,t.creating;var e=t.coor;this.hideAnnotateLabels||this.drawLabel(e[0],t)},e.prototype.drawDot=function(t){var e=this,n=t.strokeStyle,a=t.fillStyle,s=t.active,h=t.coor,r=o(h.map((function(t){return t*e.scale})),2),c=r[0],l=r[1],u=new i.default.Circle({left:c,top:l,radius:this.ctrlRadius,fill:a||this.ctrlFillStyle,stroke:s?this.activeStrokeStyle:n||this.strokeStyle});this.canvas.add(u),this.canvas.renderAll(),this.hideAnnotateLabels||this.drawLabel(h,t)},e.prototype.drawCirle=function(t){var e=this,n=t.strokeStyle,a=t.fillStyle,s=t.active,h=t.coor;t.label,t.creating;var r=t.radius,c=t.ctrlsData,l=o(h.map((function(t){return t*e.scale})),2),u=l[0],d=l[1],v=new i.default.Circle({left:u,top:d,radius:r*this.scale,fill:a||this.ctrlFillStyle,stroke:s?this.activeStrokeStyle:n||this.strokeStyle});this.canvas.add(v),this.canvas.renderAll(),this.hideAnnotateLabels||this.drawLabel(c[0],t)},e.prototype.drawLine=function(t){var e,n,a,s=this,h=t.strokeStyle,r=t.active,c=t.creating,l=t.coor;if(l.forEach((function(t,a){var h=o(t.map((function(t){return Math.round(t*s.scale)})),2),r=h[0],c=h[1];0===a?e=new i.default.Point(r,c):n=new i.default.Point(r,c)})),c){var u=o(this.mouse||[],2),d=u[0],v=u[1];n=new i.default.Point(d,v)}e&&n&&(a=new i.default.Line([e.x,e.y,n.x,n.y],{stroke:r||c?this.activeStrokeStyle:h||this.strokeStyle,strokeWidth:this.LineWidth})),this.canvas.add(a),this.canvas.renderAll(),this.hideAnnotateLabels||this.drawLabel(l[0],t)},e.prototype.drawCtrl=function(t){var e=this,n=o(t.map((function(t){return t*e.scale})),2),a=n[0],s=n[1],h=new i.default.Circle({left:a,top:s,radius:this.ctrlRadius,fill:this.ctrlFillStyle,stroke:this.ctrlStrokeStyle});this.canvas.add(h),this.canvas.renderAll()},e.prototype.drawCtrlList=function(t){var e=this;t.ctrlsData.forEach((function(i,n){5===t.type?1===n&&e.drawCtrl(i):e.drawCtrl(i)}))},e.prototype.drawLabel=function(t,e){var n=this,a=e.label,s=void 0===a?"":a;e.labelFillStyle;var h=e.labelFont,r=void 0===h?"":h,c=e.textFillStyle,l=void 0===c?"":c,u=e.hideLabel,d=void 0!==u&&u;if(s.length&&!d&&!this.hideLabel){var v=r||this.labelFont,p=parseInt(v)+6,f=s.length<this.labelMaxLen+1?s:"".concat(s.slice(0,this.labelMaxLen),"..."),g=new i.default.Text(f,{fontSize:16,fill:l||this.textFillStyle}),y=g,I=o(t.map((function(t){return t*n.scale})),2),S=I[0],m=I[1],M=this.IMAGE_ORIGIN_WIDTH-t[0]<(y.width+4)/this.scale,b=this.IMAGE_ORIGIN_HEIGHT-t[1]<p/this.scale;g.set({left:M?S-y.width-2:S+2,top:b?m-3:m+p-4}),this.canvas.add(g),this.canvas.renderAll()}},e.prototype.update=function(){var t=this;clearTimeout(this.timer),this.timer=setTimeout((function(){for(var e=t.focusMode?t.activeShape.type?[t.activeShape]:[]:t.dataset,i=function(i){var n=e[i];if(n.hide)return"continue";switch(n.type){case 1:case 7:case 9:case 8:t.drawRect(n);break;case 2:t.drawPolygon(n);break;case 3:t.drawDot(n);break;case 4:case 6:if(!t.activeShape.creating&&n.rectangleConnectivity.length>0){if(t.parentRectangleConnectivity=t.dataset.find((function(t){return t.index===n.rectangleConnectivity[0][0]})),t.childRectangleConnectivity=t.dataset.find((function(t){return t.index===n.rectangleConnectivity[0][1]})),t.parentRectangleConnectivity&&t.childRectangleConnectivity){var a=t.getDomRect(t.parentRectangleConnectivity.coor),s=t.getDomRect(t.childRectangleConnectivity.coor);t.drawShortestLine(a,s,n)}}else t.drawLine(n);break;case 5:t.drawCirle(n)}},n=0;n<e.length;n++)i(n);[1,2,4,5,6,7,8].includes(t.activeShape.type)&&!t.activeShape.hide&&t.drawCtrlList(t.activeShape),t.emit("updated",t.dataset)}))},e.prototype.deleteByIndex=function(t){var e,i=this,n=this.dataset.findIndex((function(e){return e.index===t})),a=[n],s=this.dataset[n].rectangleConnectivity.length>0?this.dataset[n].rectangleConnectivity:[];if(s.length>0)for(var h=function(t){var h=o(s[t].map((function(t){return t})),2),c=h[0],l=h[1];if(6===r.dataset[n].type){var u=r.dataset.find((function(t){return t.index===c})).rectangleConnectivity,d=r.dataset.find((function(t){return t.index===l})).rectangleConnectivity;u.forEach((function(t,e){t[0]===c&&t[1]===l&&u.splice(e,1)})),d.forEach((function(t,e){t[0]===c&&t[1]===l&&d.splice(e,1)}))}else{if(r.dataset.forEach((function(t,e){var i;null===(i=t.rectangleConnectivity)||void 0===i||i.length,e!==n&&t.rectangleConnectivity.forEach((function(e,i){e[0]===c&&e[1]===l&&t.rectangleConnectivity.splice(i,1)}))})),(null===(e=r.dataset[n])||void 0===e?void 0:e.lineCoorIndex.length)>0)r.dataset[n].lineCoorIndex.forEach((function(t,e){a.push(i.dataset.findIndex((function(e){return e.index===t}))),i.dataset.forEach((function(e,i){var a;(null===(a=e.lineCoorIndex)||void 0===a?void 0:a.length)>0&&i!==n&&-1!==e.lineCoorIndex.findIndex((function(e){return e===t}))&&e.lineCoorIndex.splice(e.lineCoorIndex.findIndex((function(e){return e===t})),1)}))}))}},r=this,c=0;c<s.length;c++)h(c);if(n>-1){this.emit("delete",this.dataset[n]);var l=this.dataset.filter((function(t,e){return!a.includes(e)}));l.forEach((function(t,e){var i=t.index,n=e,a=0===t.lineCoorIndex.length;l.forEach((function(t,e){var s,h;(null===(s=t.rectangleConnectivity)||void 0===s?void 0:s.length)>0&&(t.rectangleConnectivity=t.rectangleConnectivity.map((function(t){var e=o(t.map((function(t){return t})),2),a=e[0],s=e[1];return a===i&&(a=n),s===i&&(s=n),t=[a,s]}))),(null===(h=t.lineCoorIndex)||void 0===h?void 0:h.length)>0&&a&&(t.lineCoorIndex=t.lineCoorIndex.map((function(t){return t===i&&(t=n),t})))})),t.index=e})),this.dataset=l,this.update()}},e.prototype.calcStep=function(t){void 0===t&&(t=""),this.IMAGE_WIDTH<this.WIDTH&&this.IMAGE_HEIGHT<this.HEIGHT&&(""!==t&&"b"!==t||(this.setScale(!0,!1,!0),this.calcStep("b")))},e.prototype.setScaleOld=function(t,e,i){if(void 0===e&&(e=!1),void 0===i&&(i=!1),!this.lock&&!(!t&&(this.IMAGE_WIDTH<=this.WIDTH&&this.IMAGE_HEIGHT<=this.HEIGHT||this.scaleStep<0)||t&&this.IMAGE_WIDTH>=10*this.imageOriginMax)){t?this.scaleStep++:this.scaleStep--;var n=0,a=0,s=o(this.mouse||[],2),h=s[0],r=s[1];e&&(n=(h-this.originX)/this.scale,a=(r-this.originY)/this.scale),Math.abs(this.scaleStep);var c=this.IMAGE_WIDTH;if(this.IMAGE_WIDTH=Math.round(this.IMAGE_ORIGIN_WIDTH*(this.scaleStep>=0?1.05:.95)),this.IMAGE_HEIGHT=Math.round(this.IMAGE_ORIGIN_HEIGHT*(this.scaleStep>=0?1.05:.95)),e)this.originX=h-n*this.scale,this.originY=r-a*this.scale;else{var l=this.IMAGE_WIDTH/c;this.originX=this.WIDTH/2-(this.WIDTH/2-this.originX)*l,this.originY=this.HEIGHT/2-(this.HEIGHT/2-this.originY)*l}i||this.update()}},e.prototype.setScale=function(t,e,i){if(void 0===e&&(e=!1),void 0===i&&(i=!1),!this.lock&&!(!t&&(this.IMAGE_WIDTH<=this.WIDTH&&this.IMAGE_HEIGHT<=this.HEIGHT||this.scaleStep<0)||t&&this.IMAGE_WIDTH>=10*this.imageOriginMax)){var n=this.ZoomLevel,a=n,s=100/n;t?(a+=10)>400&&(a=400):(a-=10)<100&&(a=100);var h=o(this.mouse||[],2),r=h[0],c=h[1];e&&(this.originX,this.scale,this.originY,this.scale),Math.abs(this.scaleStep);var l=this.IMAGE_WIDTH,u=this.IMAGE_WIDTH*s,d=this.IMAGE_HEIGHT*s;if(this.IMAGE_WIDTH=Math.round(u*(a/100)),this.IMAGE_HEIGHT=Math.round(d*(a/100)),this.ZoomLevel=a,e)this.originX-=r/(this.scale*a)-r/this.scale,this.originY-=c/(this.scale*a)-c/this.scale;else{var v=this.IMAGE_WIDTH/l;this.originX=this.WIDTH/2-(this.WIDTH/2-this.originX)*v,this.originY=this.HEIGHT/2-(this.HEIGHT/2-this.originY)*v}i||n===a||this.update()}},e.prototype.fitZoom=function(){this.calcStep(),this.IMAGE_HEIGHT/this.IMAGE_WIDTH>=this.HEIGHT/this.WIDTH?(this.IMAGE_WIDTH=this.IMAGE_ORIGIN_WIDTH/(this.IMAGE_ORIGIN_HEIGHT/this.HEIGHT),this.IMAGE_HEIGHT=this.HEIGHT):(this.IMAGE_WIDTH=this.WIDTH,this.IMAGE_HEIGHT=this.IMAGE_ORIGIN_HEIGHT/(this.IMAGE_ORIGIN_WIDTH/this.WIDTH)),this.originX=0,this.originY=0,this.ZoomLevel=100,this.update()},e.prototype.setFocusMode=function(t){this.focusMode=t,this.update()},e.prototype.destroy=function(){this.image.removeEventListener("load",this.handleLoad),this.canvas.off("contextmenu",this.handleContextmenu),this.canvas.off("mousewheel",this.handleMousewheel),this.canvas.off("wheel",this.handleMousewheel),this.canvas.off("mousedown",this.handleMouseDown),this.canvas.off("touchend",this.handleMouseDown),this.canvas.off("mousemove",this.handelMouseMove),this.canvas.off("touchmove",this.handelMouseMove),this.canvas.off("mouseup",this.handelMouseUp),this.canvas.off("mouseleave",this.handelLeave),this.canvas.off("touchend",this.handelMouseUp),this.canvas.off("dblclick",this.handelDblclick),document.body.removeEventListener("keyup",this.handelKeyup),this.canvasParentNode.removeEventListener("scroll",this.handleScroll),this.canvas.setWidth(this.WIDTH),this.canvas.setHeight(this.HEIGHT),this.canvas.renderAll()},e.prototype.resize=function(){this.canvas.setWidth(null),this.canvas.setHeight(null),this.canvas.renderAll(),this.initSetting(),this.update()},e}(u)}));
//# sourceMappingURL=canvas-select.min.js.map
